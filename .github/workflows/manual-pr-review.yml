name: Manual PR Review

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull Request number to review"
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  manual-review:
    name: Manual Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Validate PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.inputs.pr_number }};

            try {
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              if (pr.data.state !== 'open') {
                core.setFailed(`PR #${prNumber} is not open (state: ${pr.data.state})`);
                return;
              }
              
              core.setOutput('head_sha', pr.data.head.sha);
              core.setOutput('base_ref', pr.data.base.ref);
              core.setOutput('pr_title', pr.data.title);
              console.log(`âœ… Found PR #${prNumber}: ${pr.data.title}`);
            } catch (error) {
              core.setFailed(`Failed to fetch PR #${prNumber}: ${error.message}`);
            }

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_sha }}
          fetch-depth: 0

      - name: Get diff
        run: |
          git fetch origin ${{ steps.pr.outputs.base_ref }} --depth=1

          # Get the diff content (limited to 8000 chars to avoid token limits)
          DIFF=$(git diff origin/${{ steps.pr.outputs.base_ref }}...HEAD -- '*.js' '*.ts' '*.py' '*.go' '*.java' '*.rb' '*.php' '*.jsx' '*.tsx' '*.vue' '*.svelte' | head -c 8000)

          echo "$DIFF" > /tmp/pr_diff.txt

          # Check if diff is empty
          if [ ! -s /tmp/pr_diff.txt ]; then
            echo "No code changes detected in supported file types." > /tmp/pr_diff.txt
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run GLM Code Review
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
        run: |
          cat << 'EOF' > review.mjs
          import https from 'https';
          import fs from 'fs';

          const diff = fs.readFileSync('/tmp/pr_diff.txt', 'utf8');
          const apiKey = process.env.ZHIPU_API_KEY;

          if (!apiKey) {
            console.error('Error: ZHIPU_API_KEY is not set');
            process.exit(1);
          }

          if (!diff.trim() || diff.includes('No code changes detected')) {
            console.log('No code changes detected in supported file types.');
            process.exit(0);
          }

          const systemPrompt = `You are an expert code reviewer. Analyze code changes and provide:
          1. ðŸ› **Potential Bugs**: Issues that could cause runtime errors
          2. ðŸ”’ **Security Concerns**: Vulnerabilities or security risks
          3. âš¡ **Performance**: Inefficiencies or optimization opportunities
          4. ðŸ“ **Code Quality**: Readability, maintainability, best practices
          5. âœ… **What's Good**: Positive aspects of the changes

          Be concise and actionable. Use markdown formatting.
          If the code looks good, say so briefly.`;

          const userPrompt = `Please review these code changes:\n\n\`\`\`diff\n${diff}\n\`\`\``;

          const data = JSON.stringify({
            model: "GLM-4.7",
            messages: [
              { role: "system", content: systemPrompt },
              { role: "user", content: userPrompt }
            ],
            temperature: 0.3,
            max_tokens: 2000
          });

          const options = {
            hostname: 'api.z.ai',
            path: '/api/coding/paas/v4/chat/completions',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`,
              'Content-Length': Buffer.byteLength(data)
            }
          };

          const req = https.request(options, (res) => {
            let body = '';
            res.on('data', (chunk) => body += chunk);
            res.on('end', () => {
              try {
                if (res.statusCode !== 200) {
                  console.error(`API Error (${res.statusCode}):`, body);
                  process.exit(1);
                }
                const response = JSON.parse(body);
                if (response.choices && response.choices[0]) {
                  console.log(response.choices[0].message.content);
                } else {
                  console.error('Unexpected response format:', body);
                  process.exit(1);
                }
              } catch (e) {
                console.error('Failed to parse response:', e.message);
                process.exit(1);
              }
            });
          });

          req.on('error', (e) => {
            console.error('Request failed:', e.message);
            process.exit(1);
          });

          req.write(data);
          req.end();
          EOF

          node review.mjs > review_output.txt 2>&1 || true
          cat review_output.txt

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = ${{ github.event.inputs.pr_number }};

            let review = '';
            try {
              review = fs.readFileSync('review_output.txt', 'utf8');
            } catch (e) {
              review = 'Unable to generate review. Please check the workflow logs.';
            }

            if (!review.trim()) {
              review = 'No code changes detected in supported file types.';
            }

            const body = `## ðŸ¤– GLM AI Code Review (Manual Trigger)

            ${review}

            ---
            <sub>Powered by GLM-4 | Manually triggered by @${context.actor}</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            console.log(`âœ… Review posted to PR #${prNumber}`);
